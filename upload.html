<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lost and Found - Search Items</title>
    <link rel="stylesheet" href="CSS/upload.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
    
</head>
<body>
    <div class="container">
        <h1>Lost and Found - Search Items</h1>
        
        <div class="search-section">
            <form id="searchForm">
                <div class="form-group">
                    <label for="searchTerm">Search by Item Name or Description</label>
                    <input type="text" id="searchTerm" name="searchTerm" placeholder="e.g. Black wallet, Calculus textbook...">
                </div>
                
                <div class="form-group">
                    <label for="category">Filter by Category</label>
                    <select id="category" name="category">
                        <option value="">All Categories</option>
                        <option value="Electronics">Electronics</option>
                        <option value="Clothing">Clothing</option>
                        <option value="Accessories">Accessories</option>
                        <option value="Documents">Documents</option>
                            <option value="Other">Other</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="foundDate">Filter by Found Date</label>
                    <input type="date" id="foundDate" name="foundDate">
                </div>
                
                <button type="submit" class="btn">Search Items</button>
            </form>
        </div>
        
        <div id="resultsContainer" class="results">
            <!-- Results will be populated here by JavaScript -->
            <div class="no-results">Use the search form above to find lost items</div>
        </div>
    </div>

    <script>
        document.getElementById('searchForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const searchTerm = document.getElementById('searchTerm').value;
            const category = document.getElementById('category').value;
            const foundDate = document.getElementById('foundDate').value;
            
            try {
                // Build query parameters
                const params = new URLSearchParams();
                if (searchTerm) params.append('search', searchTerm);
                if (category) params.append('category', category);
                if (foundDate) params.append('date', foundDate);
                
                const response = await fetch(`/api/items?${params.toString()}`);
                const items = await response.json();
                
                displayResults(items);
            } catch (error) {
                console.error('Error:', error);
                displayError();
            }
        });
        
        function displayResults(items) {
            const resultsContainer = document.getElementById('resultsContainer');
            
            if (items.length === 0) {
                resultsContainer.innerHTML = '<div class="no-results">No items found matching your search criteria.</div>';
                return;
            }
            
            resultsContainer.innerHTML = '';
            
            items.forEach(item => {
                const itemCard = document.createElement('div');
                itemCard.className = 'item-card';
                
                itemCard.innerHTML = `
                    <div class="item-image">
                        ${item.imageUrl 
                            ? `<img src="${item.imageUrl}" alt="${item.itemName}">` 
                            : `<div style="display: flex; align-items: center; justify-content: center; height: 100%;">No Image Available</div>`}
                    </div>
                    <div class="item-details">
                        <div class="item-name">${item.itemName}</div>
                        <div class="item-category">${item.category}</div>
                        <div class="item-meta">
                            Found on: ${new Date(item.foundDate).toLocaleDateString()}<br>
                            Location: ${item.foundLocation}
                        </div>
                        <div class="item-description">${item.description}</div>
                        <button class="claim-btn" data-id="${item._id}">Claim This Item</button>
                    </div>
                `;
                
                resultsContainer.appendChild(itemCard);
            });
            
            // Add event listeners to claim buttons
            document.querySelectorAll('.claim-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const itemId = this.getAttribute('data-id');
                    claimItem(itemId);
                });
            });
        }
        
        function displayError() {
            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.innerHTML = '<div class="no-results">An error occurred while searching. Please try again.</div>';
        }
        
        async function claimItem(itemId) {
            const studentId = prompt("Please enter your student ID to claim this item:");
            
            if (!studentId) return;
            
            try {
                const response = await fetch('/api/claim', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        itemId,
                        studentId
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    alert('Claim request submitted successfully! The security team will contact you.');
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                alert('An error occurred. Please try again.');
                console.error('Error:', error);
            }
        }
        
        // Load recent items when page loads
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('/api/items?limit=10');
                const items = await response.json();
                
                if (items.length > 0) {
                    const resultsContainer = document.getElementById('resultsContainer');
                    resultsContainer.innerHTML = '<h2 style="grid-column: 1 / -1;">Recently Found Items</h2>';
                    displayResults(items);
                }
            } catch (error) {
                console.error('Error loading recent items:', error);
            }
        });
    </script>
</body>
</html>